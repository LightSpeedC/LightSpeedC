<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=Edge, Chrome=1">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache">
<meta http-equiv="Expires" content="Thu, 01 Dec 1994 16:00:00 GMT">
</head>

<body>
日本語
<script src="console-to-window.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
void function () {
	'use strict';

	// time 時刻
	var tm = function () { return new Date().toLocaleTimeString(); };
	var time = 500;
	var seq = 1000;

	console.log(tm(), 'location.href:', location.href);
	var socket;
	connect();

	function connect() {

		socket = io(location.href);

		socket.on('news', function (msg) {
			console.log(tm(), 'news:', msg);
			msg = {id:++seq, my:'other', tm:tm()};
			console.log(tm(), 'other:', msg);
			socket.emit('my other event', msg);
		});
		socket.on('connect', function () {
			time = 500;
			console.info(tm(), 'connect');
		});
		socket.on('disconnect', function () {
			console.info(tm(), 'disconnect');
		});

		setTimeout(() => {
			socket.close();
			socket = null;
		}, 16000)

		setTimeout(function timer() {
			time *= 2;
			if (time >= 60000) time = 60000;

			if (!socket) return connect();

			setTimeout(timer, time);

			var msg = {id:++seq, my:'timer', tm:tm()};
			console.log(tm(), 'timer:', msg);
			socket.emit('my timer event', msg);
		}, time);

	}

}();
</script>

</body>
</html>
